# ------------------ SETUP --------------------

.SETUP

#Limpa Displays
LDI $0
STA @288
STA @289
STA @290
STA @291
STA @292
STA @293

#Limpa Leds
LDI $0
STA @256
STA @257
STA @258

# Inicializando posicao de constantes imutáveis
# Reservado Endereco 0 a 9
LDI $0
STA @0         # Constante 0
LDI $1         
STA @1         # Constante 1
LDI $9
STA @9         # Constante 9  

# Inicializando posições que guardaram Unidades do contador
# Reservado Endereco 10 a 19
LDI $0
STA @10       # MEN[10] = Unidades
STA @11       # MEN[11] = Dezenas
STA @12       # MEN[12] = Centenas
STA @13       # MEN[13] = Unidade de Milhar
STA @14       # MEN[14] = Dezena de Milhar
STA @15       # MEN[15] = Centena de MIlhar

# Inicializando posições que guardaram Limite Contador
# Reservado Endereco 20 a 29
# Caso limite contador nao seja selecionado, utilizar o valor padrao 999999
LDI $9
STA @20       # MEN[20] = Unidades
STA @21       # MEN[21] = Dezenas
STA @22       # MEN[22] = Centenas
STA @23       # MEN[23] = Unidade de Milhar
STA @24       # MEN[24] = Dezena de Milhar
STA @25       # MEN[25] = Centena de MIlhar

JMP .MAIN    # Pula para Rotina Principal
NOP

# -------------- INCREMENTA CONTADOR ---------------
.INCREMENTA_CONTADOR

STA @511       # Endereco 511 : Limpa Flag FlipFlop KEY0
LDA @10        # REGA = Unidade

# Verifica se valor da unidade é igual a 9:
CEQ @9         # Unidade já é = 9?
JEQ .DEZENA    # SIM : Incrementa dezena
NOP
JEQ .UNIDADE   # NÃO : Incrementa unidade
NOP 

# ------- Incrementa  Unidade
.UNIDADE
SOMA @1        # REGA = Unidade + 1
STA @10        
STA @288       # HEX0 = Unidade

JMP .VERIFICA_OVERFLOW  # Verifica Overflow
NOP

# ------- Incrementa  Dezena
.DEZENA
# Zera unidade
LDI $0
STA @10
STA @288       # HEX0 = Unidade

LDA @11        # Dezena já é 9 ? 
CEQ @9         
JEQ .CENTENA   # Sim
NOP

LDA @11        # Carrega dezena
SOMA @1
STA @11        
STA @289       # HEX1 = Dezena

JMP .VERIFICA_OVERFLOW  # Verifica Overflow
NOP

# ------- Incrementa  Centena
.CENTENA
# Zera dezena
LDI $0
STA @11
STA @289

LDA @12        # Centena já é 9?
CEQ @9
JEQ .UNIDADE_MILHAR
NOP

LDA @12        # Carrega centena
SOMA @1
STA @12        
STA @290       # HEX2 = Centena

JMP .VERIFICA_OVERFLOW   # Verifica Overflow
NOP

# ------- Incrementa Unidade de Milhar
.UNIDADE_MILHAR
# Zera centena
LDI $0
STA @12
STA @290

LDA @13        # Unidade de milhar já é 9?
CEQ @9
JEQ .DEZENA_MILHAR
NOP

LDA @13       # Carrega unidade de milhar
SOMA @1
STA @13
STA @291      # HEX3 = Unidade de milhar

JMP .VERIFICA_OVERFLOW  # Verifica Overflow
NOP

# ------- Incrementa Dezena de Milhar
.DEZENA_MILHAR
# Zera unidade de milhar
LDI $0
STA @13
STA @291

LDA @14      # Dezena de Milhar já é 9?
CEQ @9
JEQ .CENTENA_MILHAR
NOP

LDA @14       # Carrega dezena de milhar
SOMA @1
STA @14
STA @292      # HEX4 = Unidade de milhar

JMP .VERIFICA_OVERFLOW  # Verifica Overflow
NOP

# ------- Incrementa Centena de Milhar
.CENTENA_MILHAR
# Zera dezena de milhar
LDI $0
STA @14
STA @292

LDA @15      # Centena de Milhar já é 9?
CEQ @9
JEQ .ZERA_CENTENA_MILHAR
NOP

LDA @15       # Carrega dezena de milhar
SOMA @1
STA @15
STA @293      # HEX5 = Centena de milhar

JMP .VERIFICA_OVERFLOW  # Verifica Overflow
NOP

#Zera centena de milhar
.ZERA_CENTENA_MILHAR
LDI $0
STA @15
STA @293

# ------- VERIFICA OVERFLOW

.VERIFICA_OVERFLOW
# Compara unidade
LDA @10                  
CEQ @20
JEQ .COMPARA_DEZENA
NOP
JMP .FIM_INCREMENTO
NOP

# Compara dezena
.COMPARA_DEZENA
LDA @11                  
CEQ @21
JEQ .COMPARA_CENTENA
NOP
JMP .FIM_INCREMENTO
NOP

# Compara centena
.COMPARA_CENTENA
LDA @12                  
CEQ @22
JEQ .COMPARA_UNIDADE_MILHAR
NOP
JMP .FIM_INCREMENTO
NOP

# Compara unidade de milhar
.COMPARA_UNIDADE_MILHAR
LDA @13                  
CEQ @23
JEQ .COMPARA_DEZENA_MILHAR
NOP
JMP .FIM_INCREMENTO
NOP

# Compara dezena de milhar
.COMPARA_DEZENA_MILHAR
LDA @14                  
CEQ @24
JEQ .COMPARA_CENTENA_MILHAR
NOP
JMP .FIM_INCREMENTO
NOP

# Compara centena de milhar
.COMPARA_CENTENA_MILHAR
LDA @14                  
CEQ @24
JEQ .INDICA_OVERFLOW
NOP
JMP .FIM_INCREMENTO
NOP

# ------- Indicativos visuais de overflow
.INDICA_OVERFLOW

#Acende todos os leds
LDI $255
STA @256
LDI $1
STA @257
STA @258

#Limpa Displays
LDI $0
STA @288
STA @289
STA @290
STA @291
STA @292
STA @293

# ------- FIM INCREMENTO
.FIM_INCREMENTO
JMP .MAIN
NOP

# --------------- LIMPA LIMITE    ----------------
.LIMPA_LIMITE

#Limpa Displays
LDI $0
STA @288
STA @289
STA @290
STA @291
STA @292
STA @293

# Limpa valores guardados no contador
LDI $0
STA @10       # MEN[10] = Unidades
STA @11       # MEN[11] = Dezenas
STA @12       # MEN[12] = Centenas
STA @13       # MEN[13] = Unidade de Milhar
STA @14       # MEN[14] = Dezena de Milhar
STA @15       # MEN[15] = Centena de MIlhar

JMP .SET_UNIDADE

# --------------- LIMITE CONTADOR ----------------
.LIMITE_CONTADOR

LDI $1
STA @258                      # Indicativo de que esse modo foi selecionado. LEDR9

# Limpa posições de memoria e displays
JMP .LIMPA_LIMITE 

# ------ Seta valor Unidade
.SET_UNIDADE

LDI $1
STA @256                     # LEDR1 -> Indicativo limite Unidade

LDA @320                     # Lê chaves
STA @20                      # Salva valor limite unidade em MEN[20]
STA @288                     # HEX0 = Valor da unidade setado

LDA @353                     # Observa KEY1 ->  (1 -> Seta Dezena  ; 0 -> Seta Unidade) 
OP_AND @1 
CEQ @1 
JEQ .SET_DEZENA
NOP
JMP .SET_UNIDADE
NOP

# ------ Seta valor Dezena
.SET_DEZENA

STA @510                     # Limpa KEY1

LDI $2
STA @256                     # LEDR2 -> Indicativo limite Dezena

LDA @320                     # Lê chaves
STA @21                      # Salva valor limite dezena em MEN[21]
STA @289                     # HEX1 = Valor da dezena setado

LDA @353                     # Observa KEY1 ->  (1 -> Seta Centena  ; 0 -> Seta Dezena) 
OP_AND @1 
CEQ @1 
JEQ .SET_CENTENA
NOP
JMP .SET_DEZENA
NOP

# ------ Seta valor Centena
.SET_CENTENA

STA @510                     # Limpa KEY1

LDI $4
STA @256                     # LEDR3 -> Indicativo limite Centena

LDA @320                     # Lê chaves
STA @22                      # Salva valor limite centena em MEN[22]
STA @290                     # HEX2 = Valor da dezena setado

LDA @353                     # Observa KEY1 ->  (1 -> Seta Unidade Milhar  ; 0 -> Seta Centena)
OP_AND @1  
CEQ @1 
JEQ .SET_UNIDADE_MILHAR
NOP
JMP .SET_CENTENA
NOP

# ------ Seta valor Unidade de Milhar
.SET_UNIDADE_MILHAR

STA @510                     # Limpa KEY1

LDI $8
STA @256                     # LEDR4 -> Indicativo limite Centena

LDA @320                     # Lê chaves
STA @23                      # Salva valor limite unidade de milhar em MEN[23]
STA @291                     # HEX3 = Valor da dezena setado

LDA @353                     # Observa KEY1 ->  (1 -> Seta Dezena Milhar  ; 0 -> Seta Unidade de Milhar) 
OP_AND @1 
CEQ @1 
JEQ .SET_DEZENA_MILHAR
NOP
JMP .SET_UNIDADE_MILHAR
NOP

# ------ Seta valor Dezena de Milhar
.SET_DEZENA_MILHAR

STA @510                     # Limpa KEY1

LDI $16
STA @256                     # LEDR5 -> Indicativo limite Centena

LDA @320                     # Lê chaves
STA @24                      # Salva valor limite unidade de milhar em MEN[24]
STA @292                     # HEX4 = Valor da dezena setado

LDA @353                     # Observa KEY1 ->  (1 -> Seta  Centena de Milhar  ; 0 -> Seta Dezena de Milhar) 
OP_AND @1 
CEQ @1 
JEQ .SET_CENTENA_MILHAR
NOP
JMP .SET_DEZENA_MILHAR
NOP


# ------ Seta valor Dezena de Milhar
.SET_CENTENA_MILHAR

STA @510                     # Limpa KEY1

LDI $32
STA @256                     # LEDR5 -> Indicativo limite Centena

LDA @320                     # Lê chaves
STA @25                      # Salva valor limite unidade de milhar em MEN[25]
STA @293                     # HEX4 = Valor da dezena setado

LDA @322                     # Observa SW9 ->  (1 -> Seta  Centena de Milhar  ; 0 -> Seta Dezena de Milhar) 
OP_AND @1 
CEQ @0 
JEQ .FIM_LIMITE_CONTADOR
NOP
JMP .SET_CENTENA_MILHAR
NOP

# ------ Desativa modo Limite Contador
.FIM_LIMITE_CONTADOR
LDI $0                        # LEDR9 = 0
STA @258
STA @256                      # LEDR0-7 = 0

# Limpa Displays
LDI $0
STA @288
STA @289
STA @290
STA @291
STA @292
STA @293

JMP .MAIN
NOP

# -------------- REINICIA CONTAGEM -----------------

.REINICIA_CONTAGEM  
STA @509
JMP .SETUP
NOP

# -------------- ROTINA PRINCIPAL -----------------
.MAIN

LDA @352                      # Lê KEY0 
OP_AND @1
CEQ @1                        
JEQ .INCREMENTA_CONTADOR      # APERTADO
NOP
LDA @322                      # Lê chave SW9 -> Limite de Incremento
OP_AND @1 
CEQ @1                          
JEQ .LIMITE_CONTADOR          # Modo de inserir limite selecionado
NOP
LDA @356                      # FPGA_RESET : Limpa Contador e reinicia contagem
OP_AND @1
CEQ @1 
JEQ .REINICIA_CONTAGEM        
NOP
JMP .MAIN
NOP